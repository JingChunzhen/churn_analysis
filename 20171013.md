# 基于XGBoost的流失分析

<center>景春臻 levelup.ai 2017.10.20</center>

本报告旨在分析造成玩家流失的原因，融合玩家的动作特征和其余特征，应用XGBoost分类器，提取游戏中的重要流失点
<center>
## 数据预处理和实验流程
</center>

#### 实验流程
本实验中，使用狂暴之翼在2016.10.10 0:0:47至201.10.13 0:0:0的埋点数据，以自然天进行分割，得到第一，二， 三天的数据，在这三天的数据中，分别获得第一天，第二天，第三天玩家的特征和标签，在第一天的数据中，玩家大约有60%会流失，故对非流失玩家进行采样，得到的流失玩家和非流失玩家之间的比例为7348:7142，比例大约为1:1，第二天游戏玩家大约有50%会流失，所以未进行采样，在第三天中，由于数据本身的原因（第四天的数据中只统计了很小的时间段内），未进行分析，实验流程图如下
<center>![ ](/home/jingchunzhen/projects/churn_analysis/XGB流程图.png  "实验流程图")</center>

#### 动作特征

将数据以自然天分割之后，分别在这些自然天的数据中，剔除一部分冷门动作，冷门动作指在所有玩家中，操作数量很少的动作，在本实验中选择的最小动作支持度是5，即在所有玩家的所有点击次数中，操作该动作的次数小于等于5则会被剔除，由此得到玩家的动作序列

以词带模型处理玩家的动作序列，由此得到玩家动作序列的TF-IDF矩阵，单独使用动作特征使用XGBoost得到的分类准确率为73%

#### 其余特征
 
 根据数据中的信息计算玩家的派生属性，派生属性包含玩家动作时间间隔的平均值，动作时间间隔的最大值，动作种类，游戏时间，是否是vip用户，并计算玩家的战力，等级，金币，钻石，黑钻，体力的平均增长速度， 即战力，等级，金币， 钻石，黑钻，体力的变化值与时间的比值，最大值，最小值，以及变化次数
 
* 玩家动作时间间隔的平均值可以反映出玩家对于该游戏的熟练程度
* 玩家动作时间间隔和动作时间间隔的最大值可反映出游戏是否有卡点
* 玩家的战力，等级，金币，钻石，黑钻，体力的平均增长速度可以反映出玩家对于游戏是否领会，同时也反映了玩家对于游戏的熟悉程度
* 玩家的战力，等级，金币，钻石，黑钻，体力的最大和最小值可以反映玩家在游戏中的获得感和失落程度
* 玩家战力，等级，金币，钻石，黑钻等的变化次数可以反映玩家在游戏中的活跃程度
* 动作的种类，和玩家在游戏中的时长反映了玩家对于游戏本身的喜爱程度
* 用户是否是vip用户，由于只有6%的VIP用户会流失，所以用户是否是vip用户也反映了用户对于游戏的喜爱程度
 
 模型的关键参数和代码如下
 <center>`
 model = xgb.XGBClassifier(
        learning_rate=0.1, n_estimators=20, max_depth=3, subsample=1)
 `</center>
 单独使用上述特征得到的准确率为65%，使用XGBoost模型提取上述特征中较为重要的特征，所提取出的较为关键的特征为动作的平均时间间隔，战力，等级，体力，黑钻，金币，钻石的平均增长速度，最大的时间间隔，玩家的最大金币数量，玩家的总时间，玩家的总动作数量，和玩家的vip属性
 
#### 结合动作和其余特征
结合动作特征和在其余特征中提取出的关键特征得到玩家新的特征，再次使用XGBoost进行分类，并进行特征提取

<center>
## 实验结果
</center>

#### 首日用户流失分析

首日游戏玩家中，非流失用户平均的点击次数是1240，流失用户的平均点击次数是278次
由XGBoost提取的首日用户流失的具有高区分度的动作特征
在测试集上的准确率为76%
对于非流失玩家的预测精确率和召回率为72%, 60%
对于流失玩家的预测精确率和召回率为74%, 85%

在第一自然天的玩家埋点数据中，所提取的除动作特征以外的其余高区分度特征如下

<center>

特征|重要性
----|-------
玩家在该天的游戏总时长|0.27857143
玩家在该天的体力平均增长速度|0.1
玩家在该天的最大金币|0.05
玩家在该天的黑钻平均增长速度|0.021428572
玩家在该天所操作的动作种类|0.014285714
玩家在该天的所操作的动作的平均时间间隔|0.0071428572
玩家在该天的平均等级增长速度|0.0071428572
玩家在该天的金币平均增长速度|0.0071428572

</center>

在第一自然天的玩家埋点数据中，所提取的高区分度动作特征如下

<center>

动作|动作说明|在非流失玩家中该动作的平均点击次数|在流失玩家中该动作的平均点击次数|动作重要性
---------|-----------|----------|-----------------|-----
uidialog_club_tip/contentMc/bigBtn||1.20|0.35|0.05714
uidialog_shopyongheng/mc_trousers| |0.03|0.00|0.02143
uitop_hand/kktishi7|套装合成/引导关闭界面是点击别处|12.60|5.11|0.01429
ui_city_rightbottom/mc_window/mc_window/jineng/btn|主城/技能|7.06|1.98|0.01429
uidialog_guide_tip/btnOK|战斗中出现的提示面板/点击【明白了】按钮|1.31|0.17|0.01429
uidialog_find_player/fujinMc/btn_refresh| |0.80|0.13|0.01429
uidialog_gift/rc_dacan/getbtn|奖励/吃大餐-进餐|0.23|0.02|0.01429
ui_city_righttop/mc_window/kktishi|主城/引导点击战役时点击别处|4.41|1.04|0.01429
uidialog_gongxihuode/haha/item4/item|恭喜获得提示/点击第四个奖励图标|0.07|0.01|0.01429
requesting/instance2|网络连接中/点击屏幕|87.57|18.14|0.01429
uidialog_shenqi/jihuoBtn| |6.20|0.99|0.01429
/tags/icontent/c6/btnbtn| |0.33|0.03|0.01429
uidialog_pause/btnContinue|暂停界面/继续界面|0.85|0.24|0.01429
ui_city_lefttop/mc_window/maintask/btngoto1| |50.97|21.88|0.01429
loading_downpack2/awardbtn| |0.37|0.22|0.00714
uidialog_equipshow/mc_hecheng/item_final|套装合成/点击合成目标装备|0.39|0.08|0.00714
uidialog_skill/mc_window/skill_2|技能/点击第一技能|2.59|0.69|0.00714
uidialog_skill/mc_window/content/moreBtn| |0.82|0.33|0.00714
/shoujianMc/xinjianList/icontent/c2c2| |1.19|0.21|0.00714
uidialog_wing_detail/mc_total/btn_rise| |6.40|0.78|0.00714
uidialog_backpack/guide_arrow| |0.10|0.03|0.00714
/window/equiplist/icontent/c1/btn1btn1| |3.49|0.50|0.00714
uidialog_equip/window/duanzaoMC/addBtn|锻造/强化-强化加成|1.02|0.16|0.00714
ui_battle_head/lmc/catyMC/btn|关卡/守护水晶关卡，点击给水晶充能按钮|0.12|0.02|0.00714
uidialog_backpack/trousers| |0.29|0.07|0.00714
uidialog_10l/mc_model/cost_diamond_one_btn| |1.00|0.32|0.00714
uidialog_friend/btnClose|好友/关闭/|0.99|0.11|0.00714
uidialog_equiptip/dialogMc/btn1|套装合成/套装预览-装备-来源|2.46|1.19|0.00714
loading_downpack2/rrbtn| |0.74|0.41|0.00714
uidialog_gift_tips/awards/a1|奖励/签到礼-点击宝箱内第一个道具/|0.28|0.13|0.00714
/itemList/icontent/c1/item3item3| |1.18|0.24|0.00714
uidialog_equipshow/info/icon1|套装/点击武器/|2.78|0.73|0.00714
uidialog_gameover/haha/item4/item| |0.03|0.00|0.00714
uidialog_victory/yindao_xingxing|关卡/第一次星星引导界面，点击任意处|0.98|0.84|0.00714
uidialog_diamond_get/btn_sure| |0.56|0.14|0.00714
uidialog_skill/btnClose|技能/关闭|7.08|1.88|0.00714
loading_pack2/left| |0.88|0.43|0.00714
uidialog_shouchonghaoli/leiji2/blueBtn|首充豪礼界面/点击累充98元档的充值按钮|0.25|0.07|0.00714
uidialog_pk_select/p3/btn|竞技场/挑战左数第三名/|0.52|0.05|0.00714
uidialog_set/panel_normal/btn_render_num_2|设置/显示人数-中档|0.03|0.02|0.00714
uidialog_backpack/shoes|背包/靴子|0.22|0.07|0.00714
uidialog_backpack/btnClose|背包/关闭|9.51|2.71|0.00714
uidialog_guide_tip/bgBtn|战斗中出现的提示面板/点击面板任一处|0.68|0.06|0.00714
uidialog_role/btnClose|主城/关闭按钮|2.08|0.55|0.00714
/list/icontent/c1/btnbtn| |7.18|1.12|0.00714

</center>


#### 次日用户流失分析
 
 在第二自然天中，非流失用户的平均点击次数是1499，流失用户的平均点击次数是463次
在测试集上的准确率为75%
对于非流失玩家的预测精确率和召回率为74%， 76% 
对于流失玩家的预测精确率和召回率为76%, 74%

<center>

特征|重要性
-----|-------
玩家在该天的游戏总时间|0.15827338
玩家在该天的体力增长速度|0.028776979
玩家在该天所操作的动作种类|0.021582734
玩家在该天的所获得的最大金币量|0.021582743
玩家在该天的等级增长速度|0.007142448
玩家在该天的金币增长速度|0.0071942448
玩家在该天的所操作动作的最大时间间隔|0.0071942448

</center>

在第二自然天用户埋点数据中，所提取的高区分度动作如下

<center>

动作|动作说明|在非流失玩家中该动作的平均点击次数|在流失玩家中该动作的平均点击次数|动作重要性
---------|-----------|----------|-----------------|-----
/blist/icontent/c3/btnbtn| |0.00|0.15|0.19355
uidialog_failed/mc_gotoNext|角色战败/点击【点击此处继续】|2.64|0.92|0.04839
uidialog_gift/rc_day7/btn_lingjiang|奖励/七日礼-领取奖励|0.87|0.39|0.03226
uidialog_mbtask/btn| |0.72|0.34|0.02419
/window/equiplist/icontent/c1/btn1btn1| |4.73|1.23|0.02419
ui_king_rt/gohomeBtn|王者殿堂/回城|1.71|0.34|0.02419
uidialog_coinstore/mc_window/mc_bottom/bottomMc/btnSure|金库/免费开箱/开箱|2.46|0.50|0.01613
uidialog_xuezhan/btnClose| |0.45|0.04|0.01613
ui_city_righttop/mc_window/maoxian/btn|主城/冒险|6.78|1.21|0.01613
/mc_list/icontent/c2/btn_gobtn_go| |0.58|0.20|0.01613
/window/equiplist/icontent/c8/btn1btn1| |3.23|0.71|0.01613
ui_city_righttop/mc_window/subitems/sub5| |1.16|0.13|0.01613
uidialog_gift/rc_dacan/getbtn|奖励/吃大餐-进餐|0.39|0.07|0.01613
uidialog_gift/rc_online/items_6|奖励/在线礼-领取第六个奖励|0.39|0.08|0.01613
/tags/icontent/c4/btnbtn| |1.73|0.61|0.01613
ui_city_lefttop/mc_window/zxtask/btngoto2| |5.36|1.64|0.01613
uidialog_gameover/haha/nextBtn|恭喜获得提示/下一关|2.49|0.53|0.01613
uidialog_guanqiaxuanze/go|战役/关卡进入/|15.44|6.04|0.00806
uidialog_qirimubiao/tbtn2|七日目标/右边的左数第二页签|1.52|0.43|0.00806
uidialog_skill/tab_zhudong| |0.59|0.48|0.00806
uidialog_cbdg_tips/btnSure| |0.34|0.03|0.00806
uidialog_vip_ring/super_gift/item3| |0.03|0.02|0.00806
/rc_power/rewardlist/icontent/c1/btnLingqubtnLingqu| |1.33|0.36|0.00806
uidialog_sweep_hint/bg/btnClose||1.23|0.38|0.00806
uidialog_lingqu_tomorro/btn_item|明日领取/点击装备图标|0.32|0.19|0.00806
uitop_xindaoju/bg|关卡/获得新道具-点击任意处|0.17|0.16|0.00806
ui_city_lefttop/mc_window/mubiao/btngoto3| |6.37|2.50|0.00806
newfun/bg|功能开启，点击|0.78|0.32|0.00806
ui_bigmap_indexnum/im|战役/点击关卡|21.99|8.80|0.00806
uidialog_mbtask/closeBtn| |3.56|1.29|0.00806
/window/equiplist/icontent/c7/btn1btn1| |3.83|0.83|0.00806
uidialog_gongxihuode/haha/item2/item| |0.13|0.10|0.00806
/list/icontent/c3c3| |0.66|0.21|0.00806
ui_city_righttop/mc_window/subitemsbg|主城/收起功能图标|10.26|1.91|0.00806
ui_city_rightbottom/mc_window/mc_window/yulan/btn|主城/套装|2.74|0.92|0.00806
ui_city_rightbottom/mc_window/mc_window/subitems/sub2|主城/王者殿堂|5.63|1.66|0.00806
uidialog_equip/window/jinjieMC/btnSure|锻造/精炼|18.06|4.44|0.00806
ui_city_rightbottom/mc_window/mc_window/other/btn|主城/点击其他按钮|5.18|1.49|0.00806
/window/equiplist/icontent/c5/btn1btn1| |4.29|1.04|0.00806
uidialog_gongxihuode/bg|恭喜获得提示/点击关闭|18.58|6.81|0.00806
ui_battle_auto/btnFightMode|竞技场/自动战斗|12.57|5.47|0.00806
uidialog_club_create/bg/btnClose|公会/创建公会界面关闭/|0.14|0.05|0.00806
/itemList/icontent/c1/item4item4| |1.08|0.37|0.00806
/mc_list/icontent/c1/mc_items/mc_item2mc_item2| |0.02|0.01|0.00806
/tags/icontent/c2/btnbtn| |0.80|0.28|0.00806
uidialog_skill/mc_window/skill_4|技能/点击第三技能/|4.57|1.57|0.00806
uidialog_lunpan/startBtn|幸运轮盘界面/点击抽奖/|1.25|0.54|0.00806

</center>

<center>
## 总结
</center>
在第一天和第二天的玩家流失分析中，玩家的游戏总时长和体力变化与时间的比值，以及当日所获得的金币的最大量是区分度很大的特征，具体如何影响还需要做进一步的分析
在第一天所提取的关键动作特征中，技能，装备，奖励类动作具有较高的区分度
在第二天所提取的关键动作特征中， 奖励类动作具有较高的区分度
本实验还需进一步的分析


